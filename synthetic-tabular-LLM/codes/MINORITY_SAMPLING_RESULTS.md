# 🎯 深度学习方法只生成少数类样本 - 完整实验报告

## 📋 实验目标

使用 **条件采样（Conditional Sampling）** 和 **拒绝采样（Rejection Sampling）** 两种方法，让 CTGAN 和 TVAE 只生成少数类样本来平衡不平衡数据集。

---

## 📊 实验结果总结

### 1️⃣ **Travel 数据集**

#### 原始数据分布
- **Target=0**（未购买保险）：1021 条 (64.25%) - 多数类
- **Target=1**（购买保险）：568 条 (35.75%) - 少数类
- **不平衡比例**：1.8:1
- **需要生成**：453 条少数类样本

#### 实验结果

| 方法 | F1 Score | Balanced Accuracy | 训练时间 | 生成样本数 | 少数类纯度 |
|------|----------|-------------------|----------|-----------|-----------|
| **CTGAN (条件采样)** | 0.6593 | 0.7372 | 0.28 分钟 | 453 条 | 100% ✅ |
| **TVAE (条件采样)** | 0.6618 | 0.7388 | 0.12 分钟 | 453 条 | 100% ✅ |
| **CTGAN (拒绝采样)** | **0.6838** 🏆 | **0.7552** 🏆 | - | 453 条 | 100% ✅ |
| **TVAE (拒绝采样)** | 0.6593 | 0.7372 | - | 453 条 | 100% ✅ |

#### 拒绝采样效率
- **CTGAN**：生成 2265 条 → 筛选出 976 条少数类 → 保留 453 条（**效率 43.1%**）
- **TVAE**：生成 2265 条 → 筛选出 460 条少数类 → 保留 453 条（**效率 20.3%**）

#### 平衡效果
- **平衡后**：Target=0: 1021 条 (50.00%) | Target=1: 1021 条 (50.00%)
- ✅ **完美的 1:1 平衡！**

---

### 2️⃣ **Sick 数据集**

#### 原始数据分布
- **negative**（健康）：2783 条 (93.77%) - 多数类
- **sick**（生病）：185 条 (6.23%) - 少数类
- **不平衡比例**：15:1（严重不平衡！）
- **需要生成**：2598 条少数类样本

#### 实验结果

| 方法 | 生成样本数 | 少数类纯度 | 状态 |
|------|-----------|-----------|------|
| **CTGAN (条件采样)** | 2598 条 | 100% ✅ | ✅ 完成 |
| **TVAE (条件采样)** | 2598 条 | 100% ✅ | ✅ 完成 |
| **CTGAN (拒绝采样)** | 894 条 | 100% ✅ | ⚠️ 样本不足 |
| **TVAE (拒绝采样)** | 360 条 | 100% ✅ | ⚠️ 样本不足 |

#### 拒绝采样效率（严重不平衡数据）
- **CTGAN**：生成 12990 条 → 筛选出 894 条少数类（**效率仅 6.9%**）❌
- **TVAE**：生成 12990 条 → 筛选出 360 条少数类（**效率仅 2.8%**）❌

#### 关键发现
⚠️ **在严重不平衡数据集（15:1）上，拒绝采样效率极低！**
- CTGAN 和 TVAE 都倾向于生成多数类样本
- 需要生成大量样本才能筛选出足够的少数类
- **条件采样是唯一可靠的方法！**

---

## 🔍 方法对比分析

### ✅ **条件采样（Conditional Sampling）**

**原理**：
- 使用 SDV 的 `Condition` 对象指定生成条件
- 直接告诉模型："我只要少数类样本"
- 模型在生成时强制满足条件

**代码示例**：
```python
from sdv.sampling import Condition

# 创建条件：生成 453 条 Target=1 的样本
condition = Condition(num_rows=453, column_values={'Target': 1})
syn_data = ctgan.sample_from_conditions(conditions=[condition])
```

**优点**：
- ✅ **100% 精确**：生成的样本数量和类别完全符合要求
- ✅ **高效**：不浪费计算资源
- ✅ **适用于所有不平衡程度**：即使 15:1 也能完美工作

**缺点**：
- ⚠️ 需要模型支持条件采样功能
- ⚠️ 可能影响样本多样性（强制条件可能限制生成空间）

---

### ⚠️ **拒绝采样（Rejection Sampling）**

**原理**：
- 生成大量样本（如 5 倍目标数量）
- 筛选出少数类样本
- 保留需要的数量，丢弃其余

**代码示例**：
```python
# 生成 5 倍样本
total_samples = samples_needed * 5
syn_all = ctgan.sample(num_rows=total_samples)

# 筛选少数类
syn_minority = syn_all[syn_all['Target'] == 1].head(samples_needed)
```

**优点**：
- ✅ **简单直接**：不需要特殊 API
- ✅ **样本多样性好**：无条件生成，更自然
- ✅ **在轻度不平衡数据上表现优异**（Travel: 43% 效率）

**缺点**：
- ❌ **效率低**：需要生成大量无用样本
- ❌ **在严重不平衡数据上失效**（Sick: 仅 6.9% 效率）
- ❌ **无法保证生成足够样本**：可能需要多轮生成

---

## 📈 性能对比

### Travel 数据集（轻度不平衡 1.8:1）

**最佳方法**：🏆 **CTGAN (拒绝采样)**
- F1 Score: 0.6838
- Balanced Accuracy: 0.7552
- 比条件采样提升约 3.7%

**原因**：
- 拒绝采样效率高（43%），样本多样性好
- 从大量候选中筛选，质量更优

### Sick 数据集（严重不平衡 15:1）

**唯一可行方法**：✅ **条件采样**
- 拒绝采样效率太低（<7%），不实用
- 条件采样是唯一能生成足够样本的方法

---

## 💡 实践建议

### 1. **根据不平衡程度选择方法**

| 不平衡比例 | 推荐方法 | 原因 |
|-----------|---------|------|
| < 3:1 | 拒绝采样 | 效率高，样本质量好 |
| 3:1 ~ 10:1 | 条件采样 | 平衡效率和质量 |
| > 10:1 | 条件采样 | 拒绝采样效率太低 |

### 2. **拒绝采样的过采样因子**

```python
# 根据原始类别比例动态调整
majority_ratio = majority_count / minority_count
oversample_factor = max(5, int(majority_ratio * 1.5))
```

### 3. **混合策略**

对于中等不平衡数据，可以结合两种方法：
- 使用条件采样生成 70% 样本（保证数量）
- 使用拒绝采样生成 30% 样本（提升多样性）

---

## 📁 生成的文件

### Sick 数据集
- ✅ `Sick_CTGAN_minority_only.csv` (2598 条，100% sick)
- ✅ `Sick_TVAE_minority_only.csv` (2598 条，100% sick)
- ⚠️ `Sick_CTGAN_rejection_sampling.csv` (894 条，样本不足)
- ⚠️ `Sick_TVAE_rejection_sampling.csv` (360 条，样本不足)

### Travel 数据集
- ✅ `Travel_CTGAN_minority_only.csv` (453 条，100% Target=1)
- ✅ `Travel_TVAE_minority_only.csv` (453 条，100% Target=1)
- ✅ `Travel_CTGAN_rejection_sampling.csv` (453 条，100% Target=1)
- ✅ `Travel_TVAE_rejection_sampling.csv` (453 条，100% Target=1)

---

## 🎯 核心结论

1. **条件采样是处理不平衡数据的最可靠方法**
   - 100% 精确，适用于所有不平衡程度
   - 推荐作为默认方法

2. **拒绝采样在轻度不平衡数据上表现优异**
   - Travel 数据集上取得最佳性能
   - 但在严重不平衡数据上不实用

3. **CTGAN 在拒绝采样中效率更高**
   - Travel: 43% vs TVAE 20%
   - Sick: 6.9% vs TVAE 2.8%

4. **实际应用建议**
   - 优先使用条件采样（稳定可靠）
   - 如果追求极致性能，可在轻度不平衡数据上尝试拒绝采样
   - 严重不平衡数据（>10:1）必须使用条件采样

---

## 🚀 运行脚本

```bash
# Sick 数据集
python run_dl_minority_only_sick.py

# Travel 数据集
python run_dl_minority_only_travel.py

# 验证生成结果
python verify_minority_samples.py
```

---

**实验完成时间**：2025-11-29  
**实验人员**：Augment Agent  
**数据集**：Sick (严重不平衡), Travel (轻度不平衡)  
**方法**：CTGAN + TVAE × 条件采样 + 拒绝采样

